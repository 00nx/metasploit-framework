# -*- coding: binary -*-

# GitLab version mixin
module Msf::Exploit::Remote::HTTP::Gitlab::Version
  # Used to check if the version is correct: must contain at least one dot
  GITLAB_VERSION_PATTERN = '(\d+\.\d+(?:\.\d+)*)'.freeze
  # CSS-based filename fingerprinting
  GITLAB_CSS_PATTERN = '<link rel="stylesheet"(?: media="[a-z]+")? href="/assets/application-([a-z0-9]+)[.]css"'.freeze
  # Map of CSS filenames to gitlab versions
  GITLAB_CSS_MAP = {
    '67ac5da9c95d82e894c9efe975335f9e8bdae64967f33652cd9a97b5449216d2' => '11.1',
    '3cbf1ae156fa85f16d4ca01321e0965db8cfb9239404aaf52c3cebfc5b4493fb' => '11.9',
    '292ca64c0c109481b0855aea6b883a588bd293c6807e9493fc3af5a16f37f369' => '11.9.0',
    '2eaf7e76aa55726cc0419f604e58ee73c5578c02c9e21fdbe7ae887925ea92ae' => '11.10.0-rc7.ce.0',
    '34031b465d912c7d03e815c7cfaff77a3fa7a9c84671bb663026d36b1acd3f86' => '11.11.0-rc4',
    '93ebf32a4bd988b808c2329308847edd77e752b38becc995970079a6d586c39b' => '11.10',
    '38981e26a24308976f3a29d6e5e2beef57c7acda3ad0d5e7f6f149d58fd09d3d' => '11.10.5-ce.0',
    '9c095c833db4364caae1659f4e4dcb78da3b5ec5e9a507154832126b0fe0f08e' => '11.11.0-rc1.ce.0',
    '5440e2dd89d3c803295cc924699c93eb762e75d42178eb3fe8b42a5093075c71' => '11.11',
    '77566acc818458515231d0a82c131a42890d771ea998b9f578dc38e0eb7e517f' => '12.0',
    '340c31a75c5150c5e501ec143849adbed26fed0da5a5ee8c60fb928009ea3b86' => '12.1.0-ce.0',
    '78812856e55613c6803ecb31cc1864b7555bf7f0126d1dfa6f37376d37d3aeab' => '12.1',
    'd56f0577fbbbd6f159e9be00b274270cb25b60a7809871a6a572783b533f5a3c' => '12.2',
    'def1880ada798c68ee010ba2193f53a2c65a8981871a634ae7e18ccdcd503fa3' => '12.3',
    '3407a4fd892e9d5024f3096605eb1e25cad75a8bf847d26740a1e6a77e45b087' => '12.4',
    '73a21594461cbc9a2fb00fc6f94aec1a33ccf435a7d008d764ddd0482e08fc8d' => '12.5.0-ce.0',
    'd812b9bf6957fafe35951054b9efc5be6b10c204c127aa5a048506218c34e40f' => '12.5',
    'aeddf31361633b3d1196c6483f25c484855e0f243e7f7e62686a4de9e10ec03b' => '12.6',
    '39fdbd63424a09b5b065a6cc60c9267d3f49950bf1f1a7fd276fe1ece4a35c09' => '12.7.0-ce.0',
    'bec9544b57b8b2b515e855779735ad31c3eacf65d615b4bfbd574549735111e7' => '12.7',
    '4a081f9e3a60a0e580cad484d66fbf5a1505ad313280e96728729069f87f856e' => '12.8.0-ce.0',
    'dc6b3e9c0fad345e7c45a569f4c34c3e94730c33743ae8ca055aa6669ad6ac56' => '12.8',
    '45b2cf643afd34888294a073bf55717ea00860d6a1dca3d301ded1d0040cac44' => '12.9',
    '450cbe5102fb0f634c533051d2631578c8a6bae2c4ef1c2e50d4bfd090ce3b54' => '12.10',
    'c8d8d30d89b00098edab024579a3f3c0df2613a29ebcd57cdb9a9062675558e4' => '13.0',
    '4abc4e078df94075056919bd59aed6e7a0f95067039a8339b8f614924d8cb160' => '13.1',
    'ec9dfedd7bd44754668b208858a31b83489d5474f7606294f6cc0128bb218c6d' => '13.1.0-ce.0',
    'a9308f85e95b00007892d451fd9f6beabcd8792b4c5f8cd7524ba7e941d479c9' => '13.2',
    'f154ef27cf0f1383ba4ca59531058312b44c84d40938bc8758827023db472812' => '13.2.0-ce.0',
    '455d114267e5992b858fb725de1c1ddb83862890fe54436ffea5ff2d2f72edc8' => '13.3',
    '7f1c7b2bfaa6152740d453804e7aa380077636cad101005ed85e70990ec20ec5' => '13.3.8-ce.0',
    '969119f639d0837f445a10ced20d3a82d2ea69d682a4e74f39a48a4e7b443d5e' => '13.4',
    'f9ab217549b223c55fa310f2007a8f5685f9596c579f5c5526e7dcb204ba0e11' => '13.4.0-ce.0',
    'be9a23d3021354ec649bc823b23eab01ed235a4eb730fd2f4f7cdb2a6dee453a' => '13.5.6 - 13.5.7',
    'bf1ba5d5d3395adc5bad6f17cc3cb21b3fb29d3e3471a5b260e0bc5ec7a57bc4' => '13.5.0-ce.0',
    '051048a171ccf14f73419f46d3bd8204aa3ed585a72924faea0192f53d42cfce' => '13.6.0 - 13.6.7',
    'a0c92bafde7d93e87af3bc2797125cba613018240a9f5305ff949be8a1b16528' => '13.7.0 - 13.7.0',
    '79837fd1939f90d58cc5a842a81120e8cecbc03484362e88081ebf3b7e3830e9' => '13.7.0-rc3.ce.0',
    '52560ba2603619d2ff1447002a60dcb62c7c957451fb820f1894e1ce7c23821c' => '13.8.0 - 13.8.8',
    'd161b6e25db66456f8e0603de5132d1ff90f9388d0a0305d2d073a67fd229ddb' => '13.9.0 - 13.9.7',
    '02aa9533ec4957bb01d206d6eaa51d762c7b7396362f0f7a3b5fb4dd6088745b' => '13.10.0 - 13.10.5',
    'a573aed3df818ca78ab40c01ae3514e16271a18e3c83122deab5d5623b25d4fe' => '13.11.0 - 13.11.7',
    '90abf7746df5cb82bca9949de6f512de7cb10bec97d3f5103299a9ce38d5b159' => '14.0.0 - 14.0.12',
    '5cd37ee959b5338b5fb48eafc6c7290ca1fa60e653292304102cc19a16cc25e4' => '14.1.0 - 14.1.8',
    '4f233d907f30a050ca7e40fbd91742d444d28e50691c51b742714df8181bf4e7' => '14.2.0 - 14.2.5',
    '57e83f1a3cf7c0fe3cf2357802306688dab60cf6a30d00e14e67826070db92de' => '14.2.6 - 14.2.7',
    'a8bf3d1210afa873d9b9af583e944bdbf5ac7c8a63f6eccc3d6795802bd380d2' => '14.3.0 - 14.3.3',
    '50d9206410f00bb00cc8f95865ab291c718e7a026e7fdc1fc9db0480586c4bc9' => '14.4.0',
    '775f130d36e9eb14cb67c6a63551511b87f78944cebcf6cdddb78292030341df' => '14.4.1 - 14.4.4',
    'ba74062de4171df6109c4c96da1ebe2b538bb6cc7cd55867cbdfba44777700e1' => '14.3.4 - 14.3.6',
    '1832611738f1e31dd00a8293bbf90fce9811b3eea5b21798a63890dbc51769c8' => '14.5.0 - 14.5.4',
    '8b78708916f28aa9e54dacf9c9c08d720837ce78d8260c36c0f828612567d353' => '14.6.0 - 14.6.7',
    'cfa6748598b5e507db0e53906a7639e2c197a53cb57da58b0a20ed087cc0b9d5' => '14.7.0 - 14.7.7',
    '1d840f0c4634c8813d3056f26cbab7a685d544050360a611a9df0b42371f4d98' => '14.8.0 - 14.8.6',
    '003236d7e2c5f1f035dc8b67026d7583ee198b568932acd8faeac18cec673dfa' => '14.9.0 - 14.9.5',
    '739a920f5840de93f944ec86c5a181d0205f1d9e679a4df1b9bf5b0882ab848a' => '14.10.0 - 14.10.5',
    '1062bbba2e9b04e360569154a8df8705a75d9e17de1a3a9acd5bd20f000fec8b' => '15.0.0 - 15.0.5',
    '7d0792b17e1d2ccac7c6820dda1b54020b294006d7867b7d78a05060220a0213' => '15.1.0 - 15.1.6',
    'f74c42d987ff17ae7218016d2e49fa99c55467959a0616084a7227c53a8b702d' => '15.2.0 - 15.2.5',
    '8dcb2fd4b99a99a1c96d54c852feb9a10d712cdd32aec422cfdf03b4ee83e371' => '15.3.0 - 15.3.2',
    '1caf2b894e48f649fcfd6b20de756e07ce64c1a756b9a20ff4505caeffa1a361' => '15.3.1-ee.0',
    '6cbb01bf749e401b7f580040ef7df64328f65f40292b6df5b3384909f1b6bd88' => '15.3.3 - 15.3.5',
    '4bf4ff2b0d769377b107e2683ec22b5acaf2e63a5bfc4cbe66edd81b6ba0eb4f' => '15.4.0 - 15.4.6',
    'b1bf30dd8b5a69c9d3a8daa3c88da77db3707a1e61063616e599f10b3a23547e' => '15.5.0 - 15.5.9',
    '67bc0612f9d717c9132e562be68773069c94a2dd9f952b1622c47ab0cb0438b4' => '15.6.0 - 16.6.7',
    '1e8c169a1e3fd710539d4a64b60f69b9d1bca3ec4b8272d22f36b158ffc276fe' => '15.7.0 - 15.7.9',
    'abd1002d017cf458a22594e9eebc44f159b87466d62ff38da0a4364e1c486007' => '15.8.0 - 15.8.6',
    'c2e2e19b4ed75b3c7745158c2cccd4f82baa0ea853cd1688965c0e6865aa4fe3' => '15.9.0 - 15.9.8',
    '971982e3e67f5419507bf8034fc7ae9754f607a4f0e6a7483cd7d579936d0a43' => '15.10.0 - 15.10.8',
    'ba1723ee38768ca6dcce3e345b1f4cef7372520f2adbb0b5be32a0e6a2b6d5df' => '15.11.0 - 15.11.13',
    '77ee44de16d2f31b4ddfd214b60b6327fe48b92df7054b1fb928fd6d4439fc7e' => '16.0.0 - 16.0.8',
    'bada36d178d3db075d85c6e2bf2a094b8519c2551d4569a2c2cb8b5b2b07247c' => '16.1.0 - 16.1.6',
    '7dc3e992d5cc9567299c4981b2de6be6a12ae7c78bb9535d5485b0239c3b3f14' => '16.2.0 - 16.2.7',
    'dee053ee9a9f14f8790cb0ac27bfaf6279e364d5219b9637f1c05049e1da038e' => '16.2.8 - 16.2.9',
    'b35365c3f2d60a068185eacd7e836e1f173c0c4eb3af308fd388f1b84db673b4' => '16.3.0 - 16.3.4',
    '8ebfa16265f86eb24ceda740b31d44d2e5d86ceb9fba74eb308f08e1f99ccaa8' => '16.3.5 - 16.3.7',
    'cfc4d03e10ba8e1d144a4508f036f477fa5281690eca7258d5ef069d98614b41' => '16.4.0',
    'e803bb812a5c601a017cbfaa6d442b51c869a084d04a0e2b77dfee19959bc000' => '16.4.1 - 16.4.5',
    'deeef002fddf6f74357454676107b4ec50cf51f70394f2368f404683f1884132' => '16.5.0 - 16.5.7',
    '45a1c5dcac6ab55c1b924c47992ed649a5ac98e55dfc62e0d65b178128020aca' => '16.6.0 - 16.6.5',
    '8e1fac7546e10d24ab7482b66e2863732a6795cce85e9ff10d8bfd59cad1cd9f' => '16.7.0 - 16.7.3',
    '9412070de1081bd15748e4c0278a95f4b9b50ad910d97e8004582321e45a8858' => '16.8.0',
    'a93c372aa48b3b7d546cd010e22fdfe448dbc04e099677c6e90789487ca60f7a' => '16.9.0-pre',
    '9723ad2290324a6ed951c5d4b011743f27afa0b6450cb147a63587b67b70985a' => '16.9.1'

  }.freeze

  include Msf::Exploit::Remote::HTTP::Gitlab::Rest::V4::Version

  # Extracts the Gitlab version information
  #
  # @return [String,nil] Gitlab version if found, nil otherwise
  def gitlab_version
    version = gitlab_version_css(normalize_uri(target_uri.path))
    return version if version

    version = gitlab_version_rest
    return version if version

    version = gitlab_version_help_commit(normalize_uri(target_uri.path))
    return version if version

    nil
  end

  # Checks the name of a CSS file to fingerprint the version
  #
  # @param [String] url, the url of the Gitlab instance
  #
  # @return [String,nil] Gitlab version if found, nil otherwise
  def gitlab_version_css(url)
    res = send_request_cgi!(
      'method' => 'GET',
      'uri' => url
    )
    unless res
      return nil
    end

    match = res.body.match(GITLAB_CSS_PATTERN)
    unless match
      return nil
    end

    version =  GITLAB_CSS_MAP.fetch(match[1], nil)
   if version
     GITLAB_CSS_MAP.fetch(match[1], nil)
   else
     print_warning("The GITLAB_CSS_PATTERN was found in the response body but the hash found: #{match[1]} does not have a corresponding version in the GITLAB_CSS_MAP")
     nil
   end
  end

  # Get the commit hash via the `gon.revision` javascript variable
  #
  # @param [String] url, the url of the Gitlab instance
  #
  # @return [String,nil] Gitlab commit hash if found, nil otherwise
  def gitlab_version_help_commit(url)
    res = send_request_cgi!(
      'method' => 'GET',
      'uri' => normalize_uri(url, '/help')
    )
    unless res
      return nil
    end

    match = res.body.match(';gon[.]revision="([0-9a-f]+)";')
    unless match
      return nil
    end
    return match[1]
  end
end
