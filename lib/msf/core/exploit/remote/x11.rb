# -*- coding: binary -*-

#
# This mixin is a simplistic implementation of X11
#
# Wireshark dissector: https://wiki.wireshark.org/X11
#

module Msf::Exploit::Remote::X11
  include Msf::Exploit::Remote::X11::Connect
  include Msf::Exploit::Remote::X11::Extensions
  include Msf::Exploit::Remote::X11::Xkeyboard

  class X11GETPROPERTYRESPONSE < BinData::Record
    endian :little
    uint8 :reply
    uint8 :format
    uint16 :sequence_number # GetProperty
    uint32 :reply_length
    uint32 :get_property_type # 8bit boolean, \x01 == true \x00 == false
    uint32 :bytes_after
    uint32 :value_length
    uint32 :unused
    uint32 :unused1
    uint32 :unused2
    string :value_data, read_length: -> { value_length }
  end

  class X11GETPROPERTY < BinData::Record
    endian :little
    uint8 :opcode, value: 20 # GetProperty
    uint8 :delete_field, initial_value: 0 # \x00 false, assuming \x01 true?
    uint16 :request_length, value: -> { num_bytes / 4 }
    uint32 :window # X11CONNECTION.screen_root
    uint32 :property, value: 23 # "\x17\x00\x00\x00" RESOURCE_MANAGER
    uint32 :get_property_type, value: 31 # "\x1f\x00\x00\x00" # get-property-type (31 = string)
    uint32 :long_offset, value: 0
    uint32 :content_length, value: 100_000_000 # "\x00\xe1\xf5\x05"
  end

  class X11CREATEGRAPHICALCONTEXTREQUEST < BinData::Record
    endian :little
    uint8 :opcode, value: 55 # CreateGC (CreateGraphicalContext)
    uint8 :unused
    uint16 :request_length, value: -> { num_bytes / 4 }
    uint32 :cid # X11CONNECTION.resource_id
    uint32 :drawable # X11CONNECTION.screen_root
    # gc-value-mask mappings from wireshark, uint32 total size
    # .... .... .... .... .... .... .... ...0 = function: False
    # .... .... .... .... .... .... .... ..0. = plane-mask: False
    # .... .... .... .... .... .... .... .0.. = foreground: False
    # .... .... .... .... .... .... .... 1... = background: True
    # .... .... .... .... .... .... ...0 .... = line-width: False
    # .... .... .... .... .... .... ..0. .... = line-style: False
    # .... .... .... .... .... .... .0.. .... = cap-style: False
    # .... .... .... .... .... .... 0... .... = join-style: False
    # .... .... .... .... .... ...0 .... .... = fill-style: False
    # .... .... .... .... .... ..0. .... .... = fill-rule: False
    # .... .... .... .... .... .0.. .... .... = tile: False
    # .... .... .... .... .... 0... .... .... = stipple: False
    # .... .... .... .... ...0 .... .... .... = tile-stipple-x-origin: False
    # .... .... .... .... ..0. .... .... .... = tile-stipple-y-origin: False
    # .... .... .... .... .0.. .... .... .... = font: False
    # .... .... .... .... 0... .... .... .... = subwindow-mode: False
    # .... .... .... ...0 .... .... .... .... = graphics-exposures: False
    # .... .... .... ..0. .... .... .... .... = clip-x-origin: False
    # .... .... .... .0.. .... .... .... .... = clip-y-origin: False
    # .... .... .... 0... .... .... .... .... = clip-mask: False
    # .... .... ...0 .... .... .... .... .... = dash-offset: False
    # .... .... ..0. .... .... .... .... .... = gc-dashes: False
    # .... .... .0.. .... .... .... .... .... = arc-mode: False
    bit1 :gc_value_mask_join_style, initial_value: 0
    bit1 :gc_value_mask_cap_style, initial_value: 0
    bit1 :gc_value_mask_line_style, initial_value: 0
    bit1 :gc_value_mask_line_width, initial_value: 0
    bit1 :gc_value_mask_background, initial_value: 0
    bit1 :gc_value_mask_foreground, initial_value: 0
    bit1 :gc_value_mask_plane_mask, initial_value: 0
    bit1 :gc_value_mask_function, initial_value: 0

    bit1 :gc_value_mask_subwindow_mode, initial_value: 0
    bit1 :gc_value_mask_font, initial_value: 0
    bit1 :gc_value_mask_tile_stipple_y_origin, initial_value: 0
    bit1 :gc_value_mask_tile_stipple_x_origin, initial_value: 0
    bit1 :gc_value_mask_stipple, initial_value: 0
    bit1 :gc_value_mask_tile, initial_value: 0
    bit1 :gc_value_mask_fill_rule, initial_value: 0
    bit1 :gc_value_mask_fill_style, initial_value: 0

    bit1 :gc_value_mask_arc_mode, initial_value: 0
    bit1 :gc_value_mask_gc_dashes, initial_value: 0
    bit1 :gc_value_mask_dash_offset, initial_value: 0
    bit1 :gc_value_mask_clip_mask, initial_value: 0
    bit1 :gc_value_mask_clip_y_origin, initial_value: 0
    bit1 :gc_value_mask_clip_x_origin, initial_value: 0
    bit1 :gc_value_mask_graphics_exposures, initial_value: 0
    bit1 :gc_value_null_pad

    bit8 :gc_value_null_pad1

    uint32 :background, initial_value: 16777215
  end
end
